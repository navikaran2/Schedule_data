name: NSE Data Downloader

on:
  schedule:
    # Every Friday at 9:00 PM IST (3:30 PM UTC)
    - cron: '30 15 * * 5'
  workflow_dispatch: # Manual trigger

permissions:
  contents: write

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4
      
      - name: 🔐 Validate GitHub Token
        env:
          NIFTY_TOKEN: ${{ secrets.NIFTY_TOKEN }}
        run: |
          echo "🔐 Testing GitHub token..."
          if curl -s -H "Authorization: token ${NIFTY_TOKEN}" \
               https://api.github.com/repos/navikaran2/NIFTY | grep -q '"private": true'; then
            echo "✅ Token validated - can access private repo"
          else
            echo "❌ Token invalid or insufficient permissions"
            exit 1
          fi
      
      - name: 📝 Configure Git credentials
        env:
          NIFTY_TOKEN: ${{ secrets.NIFTY_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      
      - name: 🔥 Clone NIFTY repository
        env:
          NIFTY_TOKEN: ${{ secrets.NIFTY_TOKEN }}
        run: |
          echo "📄 Cloning NIFTY repository..."
          git clone https://x-access-token:${NIFTY_TOKEN}@github.com/navikaran2/NIFTY.git
          cd NIFTY
          echo "📂 Current directory contents:"
          ls -lh
      
      - name: 🗑️ Delete old parquet files from NIFTY repo
        env:
          NIFTY_TOKEN: ${{ secrets.NIFTY_TOKEN }}
        run: |
          cd NIFTY
          
          echo "🔍 Checking for old parquet files..."
          OLD_FILES=$(find . -maxdepth 1 -name "nse_data_*.parquet" -type f)
          
          if [ -n "$OLD_FILES" ]; then
            echo "🗑️ Found old parquet files - deleting:"
            echo "$OLD_FILES"
            rm -f nse_data_*.parquet
            
            echo "➕ Staging deletions..."
            git add -A .
            
            # Check if there are changes to commit
            if ! git diff --cached --quiet; then
              DATE_IST=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")
              echo "💾 Committing deletions..."
              git commit -m "🗑️ Cleaned old NSE parquet files on ${DATE_IST}" -m "🤖 Automated cleanup via GitHub Actions"
              
              echo "🚀 Pushing deletion to remote..."
              git remote set-url origin https://x-access-token:${NIFTY_TOKEN}@github.com/navikaran2/NIFTY.git
              git push origin main
              
              echo "✅ Old files deleted and pushed successfully!"
            else
              echo "ℹ️ No files to delete"
            fi
          else
            echo "✅ No old parquet files found - starting fresh"
          fi
      
      - name: ⚙️ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 📦 Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: 🚀 Run NSE Downloader (with retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: python nse_downloader_action.py
      
      - name: 📁 Check for parquet files
        id: check_files
        run: |
          PARQUET_FILE=$(find . -maxdepth 1 -name "nse_data_*.parquet" -type f | head -1)
          
          if [ -z "$PARQUET_FILE" ]; then
            echo "❌ No parquet file found"
            echo "file_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ Found: $PARQUET_FILE"
          FILE_SIZE=$(du -h "$PARQUET_FILE" | cut -f1)
          echo "📊 File size: $FILE_SIZE"
          echo "file_found=true" >> $GITHUB_OUTPUT
          echo "parquet_file=$PARQUET_FILE" >> $GITHUB_OUTPUT
          echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
      
      - name: ✅ Validate parquet file
        if: steps.check_files.outputs.file_found == 'true'
        run: |
          python -c "
          import pandas as pd
          import sys
          try:
              df = pd.read_parquet('${{ steps.check_files.outputs.parquet_file }}')
              rows = len(df)
              cols = len(df.columns)
              print(f'✅ Validation passed: {rows} rows, {cols} columns')
              print(f'📋 Columns: {list(df.columns)}')
              if rows == 0:
                  print('❌ Warning: Parquet file is empty!')
                  sys.exit(1)
          except Exception as e:
              print(f'❌ Validation failed: {e}')
              sys.exit(1)
          "
      
      - name: 📦 Copy new parquet file to NIFTY repo
        if: steps.check_files.outputs.file_found == 'true'
        run: |
          echo "📦 Copying new parquet file to NIFTY repo..."
          cp nse_data_*.parquet NIFTY/
          cd NIFTY
          echo "✅ Files after copy:"
          ls -lh nse_data_*.parquet
      
      - name: 💾 Commit and push new data to NIFTY repo
        if: steps.check_files.outputs.file_found == 'true'
        id: commit_step
        env:
          NIFTY_TOKEN: ${{ secrets.NIFTY_TOKEN }}
        run: |
          cd NIFTY
          
          # Set remote URL with token
          git remote set-url origin https://x-access-token:${NIFTY_TOKEN}@github.com/navikaran2/NIFTY.git
          
          echo "📄 Syncing with remote..."
          git fetch origin main
          git pull origin main
          
          echo "➕ Staging new parquet file..."
          git add nse_data_*.parquet
          
          DATE_IST=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")
          FILE_SIZE="${{ steps.check_files.outputs.file_size }}"
          
          # Check for changes
          if git diff --cached --quiet; then
            echo "ℹ️ File content identical, forcing update with empty commit..."
            git commit --allow-empty -m "✅ NSE data force updated on ${DATE_IST}" -m "📊 File size: ${FILE_SIZE}" -m "🔄 Forced update (content unchanged)" -m "🤖 Automated update via GitHub Actions"
            echo "commit_type=forced" >> $GITHUB_OUTPUT
          else
            echo "💾 Creating commit with new data..."
            git commit -m "✅ NSE data updated on ${DATE_IST}" -m "📊 File size: ${FILE_SIZE}" -m "🤖 Automated update via GitHub Actions"
            echo "commit_type=new" >> $GITHUB_OUTPUT
          fi
          
          echo "🚀 Pushing to remote..."
          git push origin main
          
          echo "✨ Data successfully pushed to NIFTY repo!"
      
      - name: 📊 Generate summary
        if: always()
        run: |
          echo "## 📈 NSE Data Downloader Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_files.outputs.file_found }}" == "true" ]; then
            echo "✅ **Status**: Success" >> $GITHUB_STEP_SUMMARY
            echo "📁 **File**: \`${{ steps.check_files.outputs.parquet_file }}\`" >> $GITHUB_STEP_SUMMARY
            echo "📊 **Size**: ${{ steps.check_files.outputs.file_size }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.commit_step.outputs.commit_type }}" == "new" ]; then
              echo "💾 **Commit**: New data pushed to NIFTY repo" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.commit_step.outputs.commit_type }}" == "forced" ]; then
              echo "🔄 **Commit**: Forced update (content unchanged)" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ **Commit**: Status unknown" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **Status**: Failed - No parquet file generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          DATE_IST=$(TZ='Asia/Kolkata' date +"%Y-%m-%d %I:%M:%S %p IST")
          echo "🕒 **Completed**: ${DATE_IST}" >> $GITHUB_STEP_SUMMARY
      
      - name: 🧹 Cleanup credentials
        if: always()
        run: |
          rm -f ~/.git-credentials
          echo "✅ Credentials cleaned up"
      
      - name: 🔧 Notify on failure
        if: failure()
        run: |
          echo "::error::❌ NSE data download/upload workflow failed!"
          echo "::error::Please check the logs for details"
          exit 1
